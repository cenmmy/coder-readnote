# 可执行文件的装载与进程

前面的章节中，我们了解了可执行文件的内部结构，这一节，我们来探讨操作系统是如何装载可执行文件的。

### 1. 进程虚拟地址空间

进程的虚拟空间地址和`cpu`的最大寻址范围有关，32位的机器，最大寻址范围是`4GB`，64位的机器，最大寻址范围为`17179869184GB`。

那么进程的虚拟地址空间是怎么分配的呢？

为了便于分析，我们以`4GB`的进程虚拟空间的分配方式来进行讲解。

`Linux`下这`4GB`的进程虚拟地址空间的分配状态如下图所示：

![](.\images\Linux进程虚拟空间分配.png)

这`4GB`的虚拟地址空间，从地址`0xC0000000`到`0xFFFFFFFF`，为操作系统所占的空间。剩下的`0x00000000`~`0xBFFFFFFF`共`3GB`的空间是留给进程使用的。

### 2. 装载方式

装载方式实际上指的是将程序执行需要的指令和数据如何放进内存的方式。现代操作系统普遍采用的方式是页映射。

假设程序 被分成了8个页，但物理内存只能够被分配成4个页，其页的装载方式如下所示：

![](.\images\页映射与页装载.png)

操作系统将程序运行时需要的页加载到内存中，当需要的页不在内存中时，便会报页错误，这时操作系统就会进行页的换出与换入。

### 3. 进程的建立

进程的建立分为三个步骤：

+ 创建一个独立的虚拟地址空间。
+ 读取可执行文件头，并且建立虚拟空间与可执行文件的映射关系。
+ 将CPU的指令寄存器设置成可执行文件的入口地址，启动执行。

#### 3.1 创建虚拟地址空间

虚拟空间由一组页映射函数将虚拟空间中的各个页映射到相应的物理空间，因此虚拟空间的创建并不是在内存中创建空间，而是创建映射函数所需要的相应的数据结构。Linux下并没有建立实际的映射关系，只是分配了一个页目录，当发生页错误的时候，在设置相应的映射关系。

#### 3.2 建立虚拟空间和可执行文件之间的映射关系

建立可执行文件和虚拟空间的映射关系是为了在发生页错误时，能够根据虚拟页找到所需要的页在可执行文件中的位置。

![](.\images\可执行文件与虚拟空间的页映射关系.jpg)

#### 3.3 将CPU指令寄存器设置成可执行文件的入口地址，启动运行

这一步很简单，如标题所述。

#### 4. 页错误

进程创建好了之后，真正的指令和数据还没有装入到内存中。

假设在上面的例子中，将CPU的指令寄存器设置为`0x08048000`，这时CPU就会打算执行这个地址的指令，但是发现这个地址所在页还没有时空页，这时就会报页错误，CPU将控制权交给操作系统，这时操作系统就会根据之前建立的可执行文件与虚拟地址空间建立的映射关系，计算出相应的页面在可执行文件中的偏移，然后从物理内存中分配一个物理页面，建立虚拟空间页与物理页之间的映射关系，然后再将控制权交给CPU。

![](.\images\页错误.png)

注意虚拟地址空间不是一块在内存中或硬盘中实际存在的空间，而是一个数据结构，用来表示虚拟空间的分布。