# Linux共享库的组织

本章主要介绍Linux操作系统下，OS如何对共享库进行管理，以方便日后的维护和升级。

### 1. 共享库版本

#### 1.1 共享库的兼容性

通常共享库是不断地进行更新，添加或修改部分功能，修正若干地Bug，最简单地情况下，共享库地更新可以被分为两类：

+ 兼容更新：所有的更新只是在原有的基础上添加一些内容，所有原有的接口都保持不变
+ 不兼容更新：共享库更新改变了原有的接口，使用该共享库的原有的接口可能不能运行或运行不正常。

注意上面所说的接口是指ABI(Application Binary Interface)接口。

导致ABI变化的可能原因有下面几种：

![](.\images\导致共享对象ABI变化的若干种原因.png)

#### 1.2 共享库版本的命名

为了解决共享库存在版本兼容的问题，最好的版本就是通过共享库版本来解决。

Linux下共享库的命名规则如下：

```txt
libname.so.x.y.z
```

前缀`lib`， 库名字`name`，共享库后缀`.so`，主版本号`x`，次版本号`y`，发布版本号`z`。

+ 主版本号：表示库的重大升级，不同主版本号之间是不兼容的。
+ 次版本号：表示库的增量升级，即增加一些新的接口符号，且保持原来的接口不变。
+ 发布版本号：表示库的一些错误的修正、性能的改进等。

#### 1.3 SO-NAME

Linux采用`SO-NAME`的命名机制来记录共享库之间的依赖关系，`SO-NAME`的命名规则很简单，就是库的版本名称去掉次版本号和发布版本号。

例如，`libfoo.so.2.6.1`对应的`SO-NAME`就是`libfoo.so.2`。系统会在当前目录中创建一个以`SO-NAME`命名的软连接。

使用`SO-NAME`好处就是使得共享库的依赖不必指定精确的版本信息，方便版本的升级。

假如我们使用精确的版本信息来指定依赖的共享库，当依赖的共享库版本升级时，我们不得不修改指定的版本信息，否则就会找不到依赖的版本库。

### 2. 共享库系统路径

Linux遵循FHS(File Hierarchy Standard)标准，这个标准规定了一个系统中的文件应该如何进行存放，包括整个目录的结构、

组织和作用，这有利于促进各个开源操作系统之间的兼容性。

FHS规定，一个操作系统中主要有三个存放共享库的地方：

+ /lib: 这个位置主要存储系统运行时需要的共享库。
+ /usr/lib: 这个位置存放系统运行时不需要但同样重要的共享库，其作用主要是开发时使用。
+ /usr/local/lib: 这个位置主要存放第三方库库。

### 3. 共享库的查找过程

+ 由环境变量`LD_LIBRARY_PATH`指定的路径查找。
+ 由路径缓存文件`/etc/ld.so.cache`指定的路径。
+ 默认共享库目录，先`/usr/lib`，后`/lib`