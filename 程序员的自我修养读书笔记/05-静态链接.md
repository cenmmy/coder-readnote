# 静态链接

静态链接：将多个目标文件链接起来，形成一个可执行文件。

### 1. 空间分配

正如我们前面学习到的，每个目标文件都有若干个段，几乎每个目标文件都有代码段和数据段，怎么处理这些目标文件的段将其整合到可执行文件中是一个问题。

现在大部分的链接器采取的策略是`相似段合并`。

![](.\images\相似段合并.png)

上图显示了A、B、C三个目标文件，将相似的段合并在一起，然后整合到可执行文件中。

### 2. 地址分配

在链接之前，目标文件中所有段的`VMA`（Virtual Memory Address）都是0，在链接之后，可执行文件中的段的`VMA`被分配了相应的虚拟地址。

![](\images\虚拟地址.png)

根据符号表分配的实际虚拟地址及符号在符号表中的偏移地址，我们就可以确定符号在可执行文件中的真实的虚拟地址。

![](\images\符号的虚拟地址.png)

### 3. 符号解析与重定位

编译器在将源代码编译称为目标文件的时候，通常会将引用的外部符号的地址进行特殊的处理，如将变量符号的地址处理成0x0000000， 将函数符号的地址处理成0xFFFFFFFC。因此在链接阶段，我们还需要将这些符号进行解析，将之前设置的临时的假的的地址替换成当前的虚拟内存地址。

链接是如何知道哪些符号是需要进行重定位的呢？我们之前了解过，需要进行重定位的段都会有一个附加段，如.text段通常会有一个.rel.text段，这个段的作用就是保存哪些符号是需要进行重定位的。

经过这三个步骤，我们就完成了静态链接。